# Build stage
FROM node:24-alpine AS builder

# Install dependencies for building
WORKDIR /app

# Copy root package files
COPY package.json yarn.lock .yarnrc.yml ./
COPY .yarn ./.yarn

# Copy workspace packages
COPY packages/shared ./packages/shared
COPY packages/server ./packages/server

# Install all dependencies
# RUN yarn install --immutable
RUN yarn install

# Build shared package first
WORKDIR /app/packages/shared
RUN yarn build

# Build server
WORKDIR /app/packages/server
RUN yarn build

# Production stage
FROM node:24-alpine

WORKDIR /app

# Copy root package files
COPY package.json yarn.lock .yarnrc.yml ./
COPY .yarn ./.yarn

# Copy built packages
COPY --from=builder /app/packages/shared/package.json ./packages/shared/package.json
COPY --from=builder /app/packages/shared/dist ./packages/shared/dist
COPY --from=builder /app/packages/shared/node_modules ./packages/shared/node_modules

COPY --from=builder /app/packages/server/package.json ./packages/server/package.json
COPY --from=builder /app/packages/server/dist ./packages/server/dist
COPY --from=builder /app/packages/server/node_modules ./packages/server/node_modules

# Set working directory to server
WORKDIR /app/packages/server

# Expose port
EXPOSE 3000

# Start server
CMD ["node", "dist/index.js"]
